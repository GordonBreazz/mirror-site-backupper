# MIRROR-SITE-BACKUPPER
Простой bash-скрипт для автоматического бэкапа сайтов с удалённого виртуального хостинга

Этот репозиторий содержит Bash-скрипт для создания резервных копий файлов сайта и баз данных на внешнем виртуальном сервере (хостинге) с использованием `rsync` и `mysqldump`. Скрипт поддерживает SSH-ключи для автоматизации и повышения безопасности процесса.

## Оглавление

1. [Требования](#требования)
2. [Настройка SSH-ключей](#настройка-ssh-ключей)
3. [Подготовка к работе](#подготовка-к-работе)
4. [Запуск скрипта](#запуск-скрипта)
5. [Планирование автоматических бэкапов](#планирование-автоматических-бэкапов)
6. [Замечания по безопасности](#замечания-по-безопасности)

---

## Требования

- Доступ к виртуальному серверу с установленным SSH.
- Привилегии на сервере для создания и чтения баз данных.
- Установленные пакеты `rsync` и `mysqldump` на локальной машине и сервере.

## Настройка SSH-ключей

### 1. Создание SSH-ключей на локальной машине

Откройте терминал и выполните следующую команду для генерации пары SSH-ключей (если она ещё не создана):

```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa
```

### Параметры:

- ```bash-t rsa```: Использование алгоритма RSA.
- ```bash-b 4096```: Длина ключа 4096 бит для повышения безопасности.
- ```bash-f ~/.ssh/id_rsa```: Путь для сохранения закрытого ключа (можно оставить по умолчанию).

Вам будет предложено указать пароль для защиты ключа. Это не обязательно, но рекомендуется для повышения безопасности.

### 2. Копирование ключа на сервер

Чтобы сервер доверял вашей локальной машине, передайте ему ваш публичный ключ:

```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub username@remote_host
```
Замените ```bash username ``` на имя пользователя, используемого для подключения, а ```bash remote_host ``` — на домен или IP-адрес сервера. Команда добавит ваш ключ в файл ```bash ~/.ssh/authorized_keys ``` на сервере.

### 3. Проверка подключения по ключу

Теперь проверьте, что подключение по SSH-ключу работает без запроса пароля:

```bash
ssh username@remote_host
```
## Подготовка к работе

1. Скачайте или склонируйте репозиторий с этим скриптом на локальную машину:
  ```bash
git clone https://github.com/GordonBreazz/site-backaper.git
cd site_backuper

```
2. Измените имена файлов и папок в начале скрипта "backup_script.sh" (если это необходимо):

```bash

# Путь к локальной папки для бекапа
LOCAL_DIR_PATH="/home/site-backup" 

# Название локальной папки для Бекапа
NAME_LOCAL_DIR="my-local-backup-dir"  

# Название папки для зеркала удалённого сервера 
NAME_MIRROR_DIR="site-mirror"       

# Название папки для дампов БД (часть зеркала)
NAME_DB_DIR=".db_dumps"             

#Название папки для логов
NAME_LOGS_DIR="logs"# 

# Название папки с симлинками на обновлённые файлы
NAME_DELTA_DIR="backup_delta"

# Название лог-файла
NAME_MAIN_LOG_FILE="backup.log"

# Название лог-файла с ошибками
NAME_ERROR_LOG_FILE="backup_error.log"

# Название лог-файла с результатами работы RSYNC
NAME_RSYNC_LOG_FILE="rsync.log"

# Название файла конфигурации c подключением к удалённому серверу и массивом данных для подключения к базам данных 
NAME_CREDENTIALS_FILE="credentials.conf"

```

3. создайте файл credentials.conf (переменуйте файл-пример "dummy-credentials.conf").
Укажите настройки подключения к удалённому сервера и параметры подключения к базам данных:

```bash

# Настройки сервера
REMOTE_USER="ваш_пользователь"                 # Имя пользователя на сервере
REMOTE_HOST="example.com"                      # Домен или IP сервера
REMOTE_DIR="/путь/к/вашему/сайту"              # Директория сайта на сервере

# Настройки баз данных
declare -A DATABASES=(
    ["имя_базы1"]="пользователь1:пароль1"
    ["имя_базы2"]="пользователь2:пароль2"
)
```
**Обратите внимание:** У разных провайдеров виртуального хостинга может отличатся путь к директории сайтов аккаунта на сервере. Для Timeweb, типичный путь будет иметь вид ``` /home/c/ca/ca1234567/ ```

4. Убедитесь, что у вас есть права доступа к базам данных, которые будут архивироваться.

## Запуск скрипта

Сделайте файл скрипта исполняемым.
```bash
chmod u+x backup_script.sh
```
Запустите скрипт, используя следующую команду:

```bash
bash backup_script.sh
```
либо

```bash
./backup_script.sh
```

Скрипт выполнит следующие действия:
- Подключится к серверу по SSH.
- Создаст дампы всех указанных баз данных и сохранит их в удалённой папке.
- Скопирует файлы сайта и дампы баз данных с сервера на локальную машину с помощью ```bash rsync ```.

### Ожидаемый результат
После завершения работы скрипта вы получите папку с бэкапом сайта и баз данных в директории, указанной в переменной ```bash BACKUP_DIR ```, с меткой даты и времени.

## Планирование автоматических бэкапов
Чтобы скрипт выполнялся автоматически, можно использовать cron (для систем на базе Linux). Пример настройки ежедневного бэкапа в 2:00 ночи:

1. Откройте cron для редактирования:
```bash
   crontab -e
```
2. Добавьте следующую строку:
```bash
   0 2 * * * /bin/bash /путь/к/backup_script.sh >> /путь/к/backup_log.txt 2>&1
```
Этот cron-запуск сохранит вывод скрипта в файл ```bash backup_log.txt ``` для мониторинга.

## Замечания по безопасности

- **Не храните пароли в скрипте в открытом виде**: Рекомендуется использовать SSH-ключи, а для защиты баз данных использовать файл .my.cnf или переменные среды.

- **Ограничьте доступ к скрипту**: Установите права доступа на выполнение скрипта только для вашего пользователя.
```bash
chmod 700 backup_script.sh
```
- Хранение бэкапов: Бэкапы содержат конфиденциальные данные. Рекомендуется регулярно архивировать и защищать их (например, с использованием шифрования).

## Поддержка
Для вопросов и предложений обратитесь к разделу **Issues** этого репозитория.
